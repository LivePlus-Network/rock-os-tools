# config.env - Configuration for rock-os-tools project
#
# This file defines environment variables used by the build system and tools.
# It is designed to be portable - the project can be moved without breaking.
#
# Usage:
#   - Automatically sourced by Makefile
#   - Source manually: source config.env
#   - Override any variable by setting it before running make

# =============================================================================
# PROJECT LOCATIONS
# =============================================================================

# Project root directory (auto-detected if not set)
# This allows the project to be moved without updating paths
if [ -n "${BASH_SOURCE[0]}" ]; then
    # Sourced from bash
    ROCK_TOOLS_ROOT="${ROCK_TOOLS_ROOT:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
elif [ -n "$0" ] && [ "$0" != "sh" ] && [ "$0" != "bash" ]; then
    # Sourced from other shell
    ROCK_TOOLS_ROOT="${ROCK_TOOLS_ROOT:-$(cd "$(dirname "$0")" && pwd)}"
else
    # Fallback to current directory
    ROCK_TOOLS_ROOT="${ROCK_TOOLS_ROOT:-$(pwd)}"
fi
export ROCK_TOOLS_ROOT

# ROCK-MASTER location (where tools will be installed)
export ROCK_MASTER_ROOT="${ROCK_MASTER_ROOT:-/Volumes/4TB/ROCK-MASTER}"

# =============================================================================
# BUILD CONFIGURATION
# =============================================================================

# Target platform detection
export BUILD_OS="${BUILD_OS:-$(uname -s | tr '[:upper:]' '[:lower:]')}"
export BUILD_ARCH="${BUILD_ARCH:-$(uname -m)}"

# Map common architecture names
case "$BUILD_ARCH" in
    x86_64)
        export BUILD_ARCH="amd64"
        ;;
    aarch64|arm64)
        export BUILD_ARCH="arm64"
        ;;
esac

# Build version (from VERSION file or default)
if [ -f "$ROCK_TOOLS_ROOT/VERSION" ]; then
    export BUILD_VERSION="$(cat "$ROCK_TOOLS_ROOT/VERSION")"
else
    export BUILD_VERSION="${BUILD_VERSION:-0.1.0}"
fi

# Build mode (debug or release)
export BUILD_MODE="${BUILD_MODE:-release}"

# =============================================================================
# INSTALLATION CONFIGURATION
# =============================================================================

# Installation directory for tools
export INSTALL_DIR="${INSTALL_DIR:-$ROCK_MASTER_ROOT/bin/tools}"

# Installation mode (copy or symlink)
export INSTALL_MODE="${INSTALL_MODE:-copy}"

# File permissions for installed tools
export INSTALL_PERMS="${INSTALL_PERMS:-755}"

# =============================================================================
# TOOL CONFIGURATION
# =============================================================================

# List of tools to build and install
export TOOLS_LIST="rock-kernel rock-deps rock-build rock-image rock-config rock-security rock-cache rock-verify rock-compose rock-registry"

# Priority tools (built first)
export PRIORITY_TOOLS="rock-kernel rock-deps rock-build"

# Optional tools (can fail without breaking build)
export OPTIONAL_TOOLS="rock-registry"

# =============================================================================
# CACHE AND DATA LOCATIONS
# =============================================================================

# Cache directory for downloaded artifacts
export CACHE_DIR="${CACHE_DIR:-$HOME/.rock/cache}"

# Data directory for persistent storage
export DATA_DIR="${DATA_DIR:-$HOME/.rock/data}"

# Temporary directory for build artifacts
export TMP_DIR="${TMP_DIR:-/tmp/rock-tools-build}"

# Log directory
export LOG_DIR="${LOG_DIR:-$HOME/.rock/logs}"

# =============================================================================
# RUNTIME CONFIGURATION
# =============================================================================

# Enable debug mode for verbose output
export DEBUG="${DEBUG:-false}"

# Enable verbose mode for detailed logging
export VERBOSE="${VERBOSE:-false}"

# Enable color output (auto-detect if not set)
if [ -t 1 ]; then
    export COLOR_OUTPUT="${COLOR_OUTPUT:-true}"
else
    export COLOR_OUTPUT="${COLOR_OUTPUT:-false}"
fi

# Maximum parallel jobs for builds
export MAX_PARALLEL="${MAX_PARALLEL:-$(sysctl -n hw.ncpu 2>/dev/null || nproc 2>/dev/null || echo 4)}"

# =============================================================================
# GO BUILD SETTINGS
# =============================================================================

# Go binary (allow override for custom Go installation)
export GO="${GO:-go}"

# Go build flags
export GO_BUILD_FLAGS="${GO_BUILD_FLAGS:--trimpath}"

# Go linker flags (for smaller binaries)
export GO_LDFLAGS="${GO_LDFLAGS:--s -w}"

# Go test flags
export GO_TEST_FLAGS="${GO_TEST_FLAGS:--v -race -cover}"

# CGO settings (disabled for static binaries)
export CGO_ENABLED="${CGO_ENABLED:-0}"

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================

# Default Volcano server for tools
export VOLCANO_HOST="${VOLCANO_HOST:-192.168.1.101}"
export VOLCANO_PORT="${VOLCANO_PORT:-50061}"
export VOLCANO_SERVER="${VOLCANO_SERVER:-$VOLCANO_HOST:$VOLCANO_PORT}"

# Debug server configuration
export DEBUG_PORT="${DEBUG_PORT:-50062}"

# MAC address prefix for ROCK-OS
export MAC_PREFIX="${MAC_PREFIX:-a4:58:0f}"

# =============================================================================
# KERNEL CONFIGURATION
# =============================================================================

# Default kernel version
export DEFAULT_KERNEL="${DEFAULT_KERNEL:-alpine:5.10.186}"

# Kernel cache directory
export KERNEL_CACHE="${KERNEL_CACHE:-$CACHE_DIR/kernels}"

# Kernel sources
export KERNEL_MIRROR="${KERNEL_MIRROR:-https://dl-cdn.alpinelinux.org/alpine}"

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================

# Certificate directory
export CERT_DIR="${CERT_DIR:-$ROCK_MASTER_ROOT/certificates}"

# Development certificates
export DEV_CERT_DIR="${DEV_CERT_DIR:-$CERT_DIR/dev}"

# Production certificates
export PROD_CERT_DIR="${PROD_CERT_DIR:-$CERT_DIR/prod}"

# Encryption algorithm
export ENCRYPTION_ALG="${ENCRYPTION_ALG:-AES-256-GCM}"

# =============================================================================
# DEVELOPMENT SETTINGS
# =============================================================================

# Enable development mode
export DEV_MODE="${DEV_MODE:-false}"

# Skip tests in development
export SKIP_TESTS="${SKIP_TESTS:-false}"

# Auto-reload on changes
export AUTO_RELOAD="${AUTO_RELOAD:-false}"

# =============================================================================
# CI/CD CONFIGURATION
# =============================================================================

# CI environment detection
if [ -n "$CI" ] || [ -n "$GITHUB_ACTIONS" ] || [ -n "$JENKINS_HOME" ]; then
    export IN_CI="true"
else
    export IN_CI="false"
fi

# CI-specific settings
if [ "$IN_CI" = "true" ]; then
    export COLOR_OUTPUT="false"
    export VERBOSE="true"
    export SKIP_INTERACTIVE="true"
fi

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

# Function to print configuration
rock_tools_config() {
    echo "rock-os-tools Configuration:"
    echo "  ROCK_TOOLS_ROOT:  $ROCK_TOOLS_ROOT"
    echo "  ROCK_MASTER_ROOT: $ROCK_MASTER_ROOT"
    echo "  BUILD_OS:         $BUILD_OS"
    echo "  BUILD_ARCH:       $BUILD_ARCH"
    echo "  BUILD_VERSION:    $BUILD_VERSION"
    echo "  BUILD_MODE:       $BUILD_MODE"
    echo "  INSTALL_DIR:      $INSTALL_DIR"
    echo "  CACHE_DIR:        $CACHE_DIR"
    echo "  DATA_DIR:         $DATA_DIR"
    echo "  DEBUG:            $DEBUG"
    echo "  VERBOSE:          $VERBOSE"
    echo "  IN_CI:            $IN_CI"
}

# Function to validate environment
rock_tools_validate() {
    local valid=true

    if [ ! -d "$ROCK_TOOLS_ROOT" ]; then
        echo "Error: ROCK_TOOLS_ROOT not found: $ROCK_TOOLS_ROOT" >&2
        valid=false
    fi

    if [ ! -d "$ROCK_MASTER_ROOT" ] && [ "$INSTALL_MODE" = "copy" ]; then
        echo "Warning: ROCK_MASTER_ROOT not found: $ROCK_MASTER_ROOT" >&2
    fi

    if ! command -v "$GO" >/dev/null 2>&1; then
        echo "Error: Go not found. Please install Go 1.21+" >&2
        valid=false
    fi

    if [ "$valid" = true ]; then
        echo "Environment validation: OK"
        return 0
    else
        echo "Environment validation: FAILED" >&2
        return 1
    fi
}

# Export functions for use in scripts
export -f rock_tools_config
export -f rock_tools_validate

# =============================================================================
# INITIALIZATION MESSAGE
# =============================================================================

# Print configuration if verbose mode is enabled
if [ "$VERBOSE" = "true" ] && [ "$IN_CI" != "true" ]; then
    rock_tools_config
fi